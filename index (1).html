<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Artem Wand Coding Kit</title>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
body { margin:0; display:flex; height:100vh; font-family:Arial, sans-serif; background:#1e1f22; color:white; }
#sidebar { width:70px; background:#2b2d31; display:flex; flex-direction:column; align-items:center; padding-top:20px; gap:16px; }
.sideIcon { width:40px; height:40px; border-radius:50%; background:#3a3c41; display:flex; justify-content:center; align-items:center; font-size:20px; cursor:pointer; }
.sideIcon:hover { background:#8ec5ff; transform:scale(1.1); }
#center { flex:1; display:flex; flex-direction:column; background:#2d2f33; }
#blocklyDiv { flex:1; }
#right { width:380px; min-width:300px; background:#1f2023; display:flex; flex-direction:column; padding:20px; gap:20px; }
#canvasBox { background:#0d0d0f; border-radius:12px; padding:4px; aspect-ratio:16/9; cursor:crosshair; position:relative; }
#canvas { width:100%; height:100%; border-radius:10px; display:block; }
.panel { background:#2b2d31; border-radius:12px; padding:10px; flex:0; display:flex; justify-content:flex-start; }
button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; margin-right:10px; }
.run { background:#8ec5ff; color:#000; }
.stop { background:#ff8e8e; color:#000; }
/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
#settingsModal { display:none; position:absolute; top:50px; left:50%; transform:translateX(-50%); width:300px; background:#2b2d31; border-radius:12px; padding:20px; z-index:100; color:white; }
#settingsModal h3 { margin-top:0; }
#settingsModal span { position:absolute; top:10px; right:15px; cursor:pointer; }
</style>
</head>
<body>

<div id="sidebar">
  <div class="sideIcon">üë§</div>
  <div class="sideIcon">üìÑ</div>
  <div class="sideIcon" id="settingsBtn">‚öôÔ∏è</div>
</div>

<div id="center">
  <div id="blocklyDiv"></div>
</div>

<div id="right">
  <div id="canvasBox"><canvas id="canvas"></canvas></div>
  <div class="panel">
    <button class="run" onclick="runCode()">‚ñ∂ Run</button>
    <button class="stop" onclick="stopCode()">‚ñ† Stop</button>
  </div>
</div>

<!-- –û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div id="settingsModal">
  <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
  <button onclick="connectBluetooth()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –ø–∞–ª–æ—á–∫—É</button>
  <button onclick="emulateConnection()">–≠–º—É–ª—è—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
  <button onclick="changeLanguage()">–Ø–∑—ã–∫</button>
  <span onclick="closeSettings()">‚úñ</span>
</div>

<xml id="toolbox" style="display:none">
  <category name="–ù–∞—á–∞–ª–æ" colour="#ffb347">
    <block type="start_program"></block>
    <block type="wand_forever"></block>
  </category>
  <category name="–î–≤–∏–∂–µ–Ω–∏–µ/–†–∏—Å–æ–≤–∞–Ω–∏–µ" colour="#8ec5ff">
    <block type="wand_move_to_xy"></block>
    <block type="wand_draw_circle">
      <value name="RADIUS"><block type="math_number"><field name="NUM">10</field></block></value>
    </block>
    <block type="wand_cast_color"></block>
  </category>
  <category name="–ü–∞–ª–æ—á–∫–∞" colour="#ffde59">
    <block type="wand_led_color"></block>
    <block type="wand_led_set"></block>
    <block type="wand_up"></block>
    <block type="wand_down"></block>
    <block type="wand_left"></block>
    <block type="wand_right"></block>
    <block type="wand_moved_x"></block>
    <block type="wand_moved_y"></block>
    <block type="wand_led_signal"></block>
  </category>
  <category name="–õ–æ–≥–∏–∫–∞" colour="#ffd28e">
    <block type="controls_if"></block>
    <block type="logic_compare"></block>
    <block type="wait_seconds">
      <value name="SECONDS"><block type="math_number"><field name="NUM">1</field></block></value>
    </block>
    <block type="math_number"></block>
  </category>
  <category name="–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ" custom="VARIABLE"></category>
</xml>

<script>
/* ---------- Theme ---------- */
const DARK_THEME = Blockly.Theme.defineTheme('dark', {
  'base': Blockly.Themes.Classic,
  'blockStyles': {
    'start_blocks': {'colourPrimary':'#ffb347','colourSecondary':'#e6993e','colourTertiary':'#cca64d'},
    'motion_blocks': {'colourPrimary':'#8ec5ff','colourSecondary':'#6ab0f3','colourTertiary':'#aad1ff'},
    'flow_blocks': {'colourPrimary':'#ffd28e','colourSecondary':'#e6b86f','colourTertiary':'#ffd699'},
    'input_blocks': {'colourPrimary':'#8eff99','colourSecondary':'#6fdc77','colourTertiary':'#a4f3aa'}
  },
  'categoryStyles': {
    'logic_category': {'colour':'#ffd28e'},
    'loop_category': {'colour':'#ffb347'},
    'motion_category': {'colour':'#8ec5ff'},
    'sensor_category': {'colour':'#8eff99'},
    'wand_category': {'colour':'#ffde59'}
  },
  'componentStyles': {
    'workspaceBackgroundColour': '#2d2f33',
    'toolboxBackgroundColour': '#1f2023',
    'toolboxForegroundColour': '#ffffff',
    'flyoutBackgroundColour': '#3a3c41',
    'flyoutForegroundColour': '#ffffff',
    'scrollbarColour': '#888',
    'scrollbarHoverColour': '#aaa'
  }
});

/* ---------- Blocks ---------- */
Blockly.defineBlocksWithJsonArray([
  { type:"start_program", message0:"–ù–∞—á–∞–ª–æ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è", nextStatement:null, style:"start_blocks" },
  { type:"wand_forever", message0:"–ü–æ–≤—Ç–æ—Ä—è—Ç—å –≤–µ—á–Ω–æ %1 %2", args0:[{type:"input_dummy"},{type:"input_statement",name:"DO"}], style:"flow_blocks" },
  { type:"wand_move_to_xy", message0:"–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫—É—Ä—Å–æ—Ä X:%1 Y:%2", args0:[
      {type:"input_value", name:"X", check:"Number"},
      {type:"input_value", name:"Y", check:"Number"}], previousStatement:null, nextStatement:null, style:"motion_blocks"
  },
  { type:"wand_draw_circle", message0:"–ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –∫—Ä—É–≥ —Ä–∞–¥–∏—É—Å %1 —Ü–≤–µ—Ç %2", args0:[
      {type:"input_value",name:"RADIUS",check:"Number"},
      {type:"field_colour", name:"COLOR", colour:"#6A0DAD"}], previousStatement:null, nextStatement:null, style:"motion_blocks"
  },
  { type:"wand_cast_color", message0:"–ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–º %1", args0:[
      {type:"field_dropdown", name:"COLOR", options:[["–°–∏–Ω–∏–π","#8ec5ff"],["–ó–µ–ª–µ–Ω—ã–π","#8eff99"],["–ö—Ä–∞—Å–Ω—ã–π","#ff8e8e"],["Random","random"]]}],
      previousStatement:null, nextStatement:null, style:"motion_blocks"
  },
  { type:"wand_led_color", message0:"–ò–∑–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ %1", args0:[{type:"field_colour", name:"COLOR", colour:"#ffde59"}], previousStatement:null, nextStatement:null, style:"motion_blocks" },
  { type:"wand_led_set", message0:"–°–≤–µ—Ç–æ–¥–∏–æ–¥ –ø–∞–ª–æ—á–∫–∏ —Ü–≤–µ—Ç %1 —è—Ä–∫–æ—Å—Ç—å %2", args0:[
      { type: "field_colour", name: "COLOR", colour: "#ffde59" },
      { type: "field_number", name: "BRIGHT", value: 100, min:0, max:100 }
  ], previousStatement:null, nextStatement:null, style:"motion_blocks" },
  { type:"wand_led_signal", message0:"–°–∏–≥–Ω–∞–ª LED %1", args0:[
      {type:"field_dropdown", name:"COLOR", options:[["–ö—Ä–∞—Å–Ω—ã–π","red"],["–°–∏–Ω–∏–π","blue"],["–ó–µ–ª–µ–Ω—ã–π","green"],["–°–ª—É—á–∞–π–Ω—ã–π","random"]]}],
      previousStatement:null, nextStatement:null, style:"motion_blocks"
  },
  { type:"wand_up", message0:"–ü–∞–ª–æ—á–∫–∞ –≤–≤–µ—Ä—Ö", output:"Boolean", style:"input_blocks" },
  { type:"wand_down", message0:"–ü–∞–ª–æ—á–∫–∞ –≤–Ω–∏–∑", output:"Boolean", style:"input_blocks" },
  { type:"wand_left", message0:"–ü–∞–ª–æ—á–∫–∞ –≤–ª–µ–≤–æ", output:"Boolean", style:"input_blocks" },
  { type:"wand_right", message0:"–ü–∞–ª–æ—á–∫–∞ –≤–ø—Ä–∞–≤–æ", output:"Boolean", style:"input_blocks" },
  { type:"wand_moved_x", message0:"–ü–∞–ª–æ—á–∫–∞ —Å–¥–≤–∏–Ω—É–ª–∞—Å—å –ø–æ X", output:"Boolean", style:"input_blocks" },
  { type:"wand_moved_y", message0:"–ü–∞–ª–æ—á–∫–∞ —Å–¥–≤–∏–Ω—É–ª–∞—Å—å –ø–æ Y", output:"Boolean", style:"input_blocks" },
  { type:"wait_seconds", message0:"–ü–æ–¥–æ–∂–¥–∞—Ç—å %1 —Å–µ–∫", args0:[{type:"input_value",name:"SECONDS",check:"Number"}], previousStatement:null, nextStatement:null, style:"flow_blocks" },
  { type:"math_number", message0:"%1", args0:[{type:"field_number",name:"NUM",value:0}], output:"Number", style:"input_blocks" }
]);

/* ---------- JS Code Generator ---------- */
Blockly.JavaScript['start_program'] = ()=> '';
Blockly.JavaScript['wand_forever'] = block => {
  const branch = Blockly.JavaScript.statementToCode(block,'DO');
  return `async function loop(){while(isRunning){${branch}await new Promise(r=>setTimeout(r,10));}}loop();`;
};
Blockly.JavaScript['wand_move_to_xy'] = block => {
  const x = Blockly.JavaScript.valueToCode(block,'X',Blockly.JavaScript.ORDER_NONE)||0;
  const y = Blockly.JavaScript.valueToCode(block,'Y',Blockly.JavaScript.ORDER_NONE)||0;
  return `cursorX=${x}; cursorY=${y};`;
};
Blockly.JavaScript['wand_draw_circle'] = block => {
  const r = Blockly.JavaScript.valueToCode(block,'RADIUS',Blockly.JavaScript.ORDER_NONE)||10;
  const color = block.getFieldValue('COLOR');
  return `history.push({type:'circle',x:cursorX+canvas.width/2,y:cursorY+canvas.height/2,r:${r},c:'${color}'});`;
};
Blockly.JavaScript['wand_cast_color'] = block => {
  const color = block.getFieldValue('COLOR');
  return `let c='${color}'; if(c==='random'){c='#'+Math.floor(Math.random()*16777215).toString(16);} history.push({type:'circle',x:cursorX+canvas.width/2,y:cursorY+canvas.height/2,r:20,c:c});`;
};
Blockly.JavaScript['wand_led_color'] = b=>`sendLedColor('${b.getFieldValue('COLOR')}');`;
Blockly.JavaScript['wand_led_set'] = b=>`sendLedColor('${b.getFieldValue('COLOR')}', ${b.getFieldValue('BRIGHT')});`;
Blockly.JavaScript['wand_led_signal'] = b=>{
  const color = b.getFieldValue('COLOR');
  return `sendLedSignal('${color}');`;
};
Blockly.JavaScript['wand_up'] = ()=>[`wandState.tiltY>20`,Blockly.JavaScript.ORDER_ATOMIC];
Blockly.JavaScript['wand_down'] = ()=>[`wandState.tiltY<-20`,Blockly.JavaScript.ORDER_ATOMIC];
Blockly.JavaScript['wand_left'] = ()=>[`wandState.tiltX<-20`,Blockly.JavaScript.ORDER_ATOMIC];
Blockly.JavaScript['wand_right'] = ()=>[`wandState.tiltX>20`,Blockly.JavaScript.ORDER_ATOMIC];
Blockly.JavaScript['wand_moved_x'] = ()=>[`Math.abs(wandState.tiltX)>5`,Blockly.JavaScript.ORDER_ATOMIC];
Blockly.JavaScript['wand_moved_y'] = ()=>[`Math.abs(wandState.tiltY)>5`,Blockly.JavaScript.ORDER_ATOMIC];
Blockly.JavaScript['wait_seconds'] = block => {
  const sec = Blockly.JavaScript.valueToCode(block,'SECONDS',Blockly.JavaScript.ORDER_NONE)||1;
  return `await new Promise(r=>setTimeout(r,${sec}*1000));`;
};
Blockly.JavaScript['math_number'] = block => [Number(block.getFieldValue('NUM')),Blockly.JavaScript.ORDER_ATOMIC];

/* ---------- Workspace ---------- */
let workspace = Blockly.inject('blocklyDiv',{
  toolbox: document.getElementById('toolbox'),
  theme:DARK_THEME,
  grid:{spacing:20,length:3,colour:'#3a3c41',snap:true},
  trashcan:true
});

/* ---------- Canvas & Particles ---------- */
let canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
let isRunning=false, cursorX=0, cursorY=0, history=[], wandState={tiltX:0, tiltY:0};
let drawInterval;

class Particle{
  constructor(){ this.reset(); }
  reset(){ this.x=canvas.width/2; this.y=canvas.height/2; this.r=5+Math.random()*15; this.life=20+Math.random()*20; this.remaining=this.life; this.speedX=-2+Math.random()*4; this.speedY=-10+Math.random()*-5; this.color=[222,111,44]; }
  update(){ this.remaining--; this.r-=0.2; this.x+=this.speedX; this.y+=this.speedY; if(this.remaining<0||this.r<0) this.reset(); }
  draw(){ const grad=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r); grad.addColorStop(0,`rgba(${this.color[0]},${this.color[1]},${this.color[2]},${Math.max(this.remaining/this.life,0)})`); grad.addColorStop(0.5,`rgba(${this.color[0]},${this.color[1]},${this.color[2]},${Math.max(this.remaining/this.life,0)})`); grad.addColorStop(1,`rgba(${this.color[0]},${this.color[1]},${this.color[2]},0)`); ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill(); }
}

let particles = [];
for(let i=0;i<80;i++) particles.push(new Particle());

function draw(){
  ctx.fillStyle='#0d0d0f';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  history.forEach(item=>{ ctx.beginPath(); ctx.arc(item.x,item.y,item.r,0,2*Math.PI); ctx.fillStyle=item.c; ctx.fill(); });
  particles.forEach(p=>{ p.update(); p.draw(); });
}

function resizeCanvas(){ canvas.width=canvas.parentElement.clientWidth-8; canvas.height=canvas.parentElement.clientHeight-8; particles.forEach(p=>p.reset()); draw(); }
window.addEventListener('resize',resizeCanvas); 
resizeCanvas();

document.getElementById('canvasBox').addEventListener('mousemove',e=>{
  const rect=canvas.getBoundingClientRect();
  wandState.tiltX=Math.round((e.clientX-rect.left)/canvas.width*200-100);
  wandState.tiltY=Math.round((e.clientY-rect.top)/canvas.height*200-100);
});
document.getElementById('canvasBox').addEventListener('mouseleave',()=>{wandState.tiltX=0;wandState.tiltY=0;});

function updateCursor() { if(isRunning){ cursorX = wandState.tiltX; cursorY = wandState.tiltY; } requestAnimationFrame(updateCursor); }
updateCursor();

async function runCode(){
  if(isRunning) return;
  isRunning=true; history=[]; cursorX=wandState.tiltX; cursorY=wandState.tiltY;
  clearInterval(drawInterval);
  drawInterval=setInterval(draw,33);
  const code = Blockly.JavaScript.workspaceToCode(workspace);
  try{ await (async()=>{await eval(code);})(); }catch(e){console.error(e);}
}

function stopCode(){ isRunning=false; clearInterval(drawInterval);}

/* ---------- Settings Functions ---------- */
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
settingsBtn.addEventListener('click', ()=>settingsModal.style.display='block');
function closeSettings(){ settingsModal.style.display='none'; }

let bluetoothDevice, bluetoothServer, ledCharacteristic;

async function connectBluetooth(){
  try{
    bluetoothDevice = await navigator.bluetooth.requestDevice({acceptAllDevices:true, optionalServices:['battery_service','generic_access']});
    bluetoothServer = await bluetoothDevice.gatt.connect();
    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫', bluetoothDevice.name);
    alert('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ: '+bluetoothDevice.name);
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∏—â–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É LED
    const service = await bluetoothServer.getPrimaryService('generic_access');
    ledCharacteristic = await service.getCharacteristic('battery_level'); // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é LED characteristic
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–∞–ª–æ—á–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è)
    ledCharacteristic.startNotifications();
    ledCharacteristic.addEventListener('characteristicvaluechanged', e=>{
      const val = e.target.value.getUint8(0);
      console.log('–°–∏–≥–Ω–∞–ª –ø–∞–ª–æ—á–∫–∏:', val);
    });
  }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: '+e);}
}

function emulateConnection(){
  alert('–≠–º—É–ª—è—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º—ã—à—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–ª–æ—á–∫–æ–π.');
}

function changeLanguage(){ alert('–°–º–µ–Ω–∏—Ç–µ —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞'); }

/* ---------- LED Functions ---------- */
function sendLedColor(color, brightness=100){
  console.log(`LED: —Ü–≤–µ—Ç ${color}, —è—Ä–∫–æ—Å—Ç—å ${brightness}%`);
  if(!ledCharacteristic) return;
  // –ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–µ—Ä–µ–∑ Bluetooth
  // const data = new Uint8Array([brightness]); ledCharacteristic.writeValue(data);
}

function sendLedSignal(color){
  let c=color;
  if(c==='random'){ c='#'+Math.floor(Math.random()*16777215).toString(16); }
  console.log('–°–∏–≥–Ω–∞–ª LED:', c);
  sendLedColor(c);
}
</script>

</body>
</html>
